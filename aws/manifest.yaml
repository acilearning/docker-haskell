version: 0.2
env:
  variables:
    AWS_REGION: us-east-1
    # This value is simply the default. It is typically overriden by the
    # workflow in `.github/workflows/workflow.yaml`.
    GHC_VERSION: 9.0.2
    LATEST: ''
phases:
  build:
    commands:

      - server=public.ecr.aws/acilearning

      - aws ecr-public get-login-password --region "$AWS_REGION" | docker login --username AWS --password-stdin "$server"

      - tag="$server/haskell:$GHC_VERSION-$CODEBUILD_RESOLVED_SOURCE_VERSION"

      - echo "$tag"

      - docker manifest create "$tag" "$tag-amd64" "$tag-arm64"

      - docker manifest push "$tag"

      - if test -z "$LATEST"; exit 0; fi

      - latest="$server/haskell:$GHC_VERSION"

      - echo "$latest"

      - docker manifest create "$latest" "$tag"

      - docker manifest push "$latest"
